const fs = require('fs');
const https = require('https');
const path = require('path');

const inputFile = 'dependencies.csv';
const outputFile = 'dependencies-with-date.csv';

function fetchReleaseDate(pkg, version) {
  return new Promise((resolve) => {
    const url = `https://registry.npmjs.org/${pkg}`;
    https.get(url, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => {
        try {
          const info = JSON.parse(data);
          const time = info.time && info.time[version];
          resolve(time || '');
        } catch {
          resolve('');
        }
      });
    }).on('error', () => resolve(''));
  });
}


// Concurrency helper
async function runWithConcurrency(tasks, limit) {
  const results = [];
  let i = 0;
  async function worker() {
    while (i < tasks.length) {
      const idx = i++;
      results[idx] = await tasks[idx]();
    }
  }
  const workers = Array.from({ length: limit }, worker);
  await Promise.all(workers);
  return results;
}

async function main() {
  const csv = fs.readFileSync(inputFile, 'utf8');
  const lines = csv.split(/\r?\n/);
  const header = lines[0].split(',');
  const idxPkg = header.indexOf('Package');
  const idxVer = header.indexOf('Version');
  const outRows = [header.concat(['ReleaseDate']).join(',')];

  // Prepare tasks
  const tasks = [];
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i].split(',');
    if (row.length < Math.max(idxPkg, idxVer) + 1) {
      tasks.push(() => Promise.resolve(lines[i] + ','));
      continue;
    }
    const pkg = row[idxPkg];
    const version = row[idxVer];
    if (!pkg || !version) {
      tasks.push(() => Promise.resolve(lines[i] + ','));
      continue;
    }
    tasks.push(async () => {
      const date = await fetchReleaseDate(pkg, version);
      console.log(`Fetched: ${pkg}@${version} -> ${date}`);
      return lines[i] + ',' + date;
    });
  }

  // Run tasks in parallel with concurrency limit
  const concurrencyLimit = 10;
  const results = await runWithConcurrency(tasks, concurrencyLimit);
  outRows.push(...results);
  fs.writeFileSync(outputFile, outRows.join('\n'));
  console.log(`CSV file created: ${outputFile}`);
}

main();
