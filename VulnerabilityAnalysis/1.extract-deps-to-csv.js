const fs = require('fs');
const path = require('path');

const lockFile = 'package-lock.json';
const outputFile = 'dependencies.csv';

const lock = JSON.parse(fs.readFileSync(lockFile, 'utf8'));

const rows = [['Type', 'Package', 'Version', 'SourcePackage']];

function addRow(type, name, version, source) {
  rows.push([type, name, version, source || '']);
}

// Get root dependencies and devDependencies
const root = lock.packages[''];
if (root.dependencies) {
  for (const [name, version] of Object.entries(root.dependencies)) {
    addRow('dependency', name, version, '');
  }
}
if (root.devDependencies) {
  for (const [name, version] of Object.entries(root.devDependencies)) {
    addRow('devDependency', name, version, '');
  }
}

// Helper to find parent package
function findParent(pkgPath) {
  const parts = pkgPath.split('/');
  if (parts.length <= 2) return '';
  // e.g. node_modules/@scope/pkg/node_modules/parent
  const idx = pkgPath.lastIndexOf('node_modules/');
  if (idx > 0) {
    const parentPath = pkgPath.substring(0, idx - 1);
    const parentName = parentPath.split('node_modules/').pop();
    return parentName || '';
  }
  return '';
}

// Get all packages and their versions, and parent
for (const [pkgPath, info] of Object.entries(lock.packages)) {
  if (pkgPath === '') continue; // skip root
  // Extract only the actual package name
  let name = pkgPath;
  if (pkgPath.includes('node_modules/')) {
    const segments = pkgPath.split('node_modules/').filter(Boolean);
    name = segments[segments.length - 1];
  }
  const parent = findParent(pkgPath);
  addRow('package', name, info.version || '', parent);
}

// Write to CSV
const csv = rows.map(row => row.join(',')).join('\n');
fs.writeFileSync(outputFile, csv);
console.log(`CSV file created: ${outputFile}`);