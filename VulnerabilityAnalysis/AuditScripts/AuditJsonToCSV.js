
const { execSync } = require('child_process');
const fs = require('fs');

// Run npm audit --json and get output
let auditJson;
try {
  auditJson = execSync('npm audit --json', { encoding: 'utf8' });
} catch (err) {
  auditJson = err.stdout;
}

const audit = JSON.parse(auditJson.trim().replace(/^\uFEFF/, ''));

const rows = [['Module', 'Vulnerable Versions', 'Severity', 'Title', 'Description', 'URL', 'CWE', 'CVSS Score']];

if (audit.vulnerabilities) {
  Object.values(audit.vulnerabilities).forEach(vuln => {
    let via = Array.isArray(vuln.via) ? vuln.via[0] : vuln.via;
    if (typeof via === 'string') via = { title: via };
    rows.push([
      (vuln.name || '').trim(),
      (via && via.range ? via.range : '').trim(),
      (vuln.severity || '').trim(),
      (via && via.title ? via.title : (vuln.title || '')).trim(),
      (via && via.description ? via.description : (vuln.description || '')).trim(),
      (via && via.url ? via.url : (vuln.url || '')).trim(),
      (via && via.cwe ? via.cwe.join(';') : (vuln.cwe ? vuln.cwe.join(';') : '')).trim(),
      (via && via.cvss && via.cvss.score ? via.cvss.score : (vuln.cvss && vuln.cvss.score ? vuln.cvss.score : '')).toString().trim()
    ]);
  });
}

const csv = rows.map(r => r.join(',')).join('\n');
fs.writeFileSync('audit-vulnerabilities.csv', csv);
console.log('CSV file created: audit-vulnerabilities.csv');